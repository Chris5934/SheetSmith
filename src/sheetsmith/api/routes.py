"""API routes for SheetSmith.\n\n"""\n\nfrom typing import Optional\nfrom pydantic import BaseModel, Field\nfrom fastapi import APIRouter, HTTPException\n\nrouter = APIRouter()\n\n\ndef get_agent():\n    """Get the global agent instance."""\n    from .app import get_agent as _get_agent\n\n    return _get_agent()\n\n\nclass ChatRequest(BaseModel):\n    """Request model for chat endpoint."""\n\n    message: str\n    spreadsheet_id: Optional[str] = None\n\n\nclass ChatResponse(BaseModel):\n    """Response model for chat endpoint."""\n\n    response: str\n    conversation_length: int\n\n\nclass SpreadsheetInfoRequest(BaseModel):\n    """Request for spreadsheet info."""\n\n    spreadsheet_id: str\n\n\nclass SearchRequest(BaseModel):\n    """Request for formula search."""\n\n    spreadsheet_id: str\n    pattern: str\n    sheet_names: Optional[list[str]] = None\n    case_sensitive: bool = False\n\n\nclass RangeReadRequest(BaseModel):\n    """Request to read a range."""\n\n    spreadsheet_id: str\n    range_notation: str\n    include_formulas: bool = True\n\n\nclass RuleCreateRequest(BaseModel):\n    """Request to create a rule."""\n\n    name: str\n    description: str\n    rule_type: str\n    content: str\n    examples: list[str] = Field(default_factory=list)\n    tags: list[str] = Field(default_factory=list)\n\n\nclass LogicBlockCreateRequest(BaseModel):\n    """Request to create a logic block."""\n\n    name: str\n    block_type: str\n    description: str\n    formula_pattern: str\n    variables: dict[str, str] = Field(default_factory=dict)\n    tags: list[str] = Field(default_factory=list)\n\n\n# Chat endpoints\n\n\n@router.post("/chat", response_model=ChatResponse)\nasync def chat(request: ChatRequest):\n    """Send a message to the SheetSmith agent."""\n    agent = get_agent()\n\n    # Add spreadsheet context if provided\n    message = request.message\n    if request.spreadsheet_id and "spreadsheet" not in message.lower():\n        message = f"[Working with spreadsheet: {request.spreadsheet_id}]\n\n{message}"\n\n    try:\n        response = await agent.process_message(message)\n        return ChatResponse(\n            response=response,\n            conversation_length=len(agent.messages),\n        )\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=str(e))\n\n\n@router.post("/chat/reset")\nasync def reset_chat():\n    """Reset the conversation history."""\n    agent = get_agent()\n    agent.reset_conversation()\n    return {"status": "ok", "message": "Conversation reset"}\n\n\n# Google Sheets endpoints\n\n\n@router.post("/sheets/info")\nasync def get_spreadsheet_info(request: SpreadsheetInfoRequest):\n    """Get information about a spreadsheet."""\n    agent = get_agent()\n    try:\n        info = agent.sheets_client.get_spreadsheet_info(request.spreadsheet_id)\n        return info\n    except Exception as e:\n        raise HTTPException(status_code=400, detail=str(e))\n\n\n@router.post("/sheets/read")\nasync def read_range(request: RangeReadRequest):\n    """Read values and formulas from a range."""\n    agent = get_agent()\n    try:\n        result = agent.sheets_client.read_range(\n            request.spreadsheet_id,\n            request.range_notation,\n            request.include_formulas,\n        )\n        return {\n            "spreadsheet_id": result.spreadsheet_id,\n            "sheet_name": result.sheet_name,\n            "range": result.range_notation,\n            "cells": [\n                {\n                    "cell": c.cell,\n                    "value": c.value,\n                    "formula": c.formula,\n                }\n                for c in result.cells\n            ],\n        }\n    except Exception as e:\n        raise HTTPException(status_code=400, detail=str(e))\n\n\n@router.post("/sheets/search")\nasync def search_formulas(request: SearchRequest):\n    """Search for formulas matching a pattern."""\n    agent = get_agent()\n    try:\n        matches = agent.sheets_client.search_formulas(\n            request.spreadsheet_id,\n            request.pattern,\n            request.sheet_names,\n            request.case_sensitive,\n        )\n        return {\n            "pattern": request.pattern,\n            "match_count": len(matches),\n            "matches": [\n                {\n                    "sheet": m.sheet_name,\n                    "cell": m.cell,\n                    "formula": m.formula,\n                    "matched_text": m.matched_text,\n                }\n                for m in matches\n            ],\n        }\n    except Exception as e:\n        raise HTTPException(status_code=400, detail=str(e))\n\n\n# Memory endpoints\n\n\n@router.get("/rules")\nasync def list_rules(rule_type: Optional[str] = None):\n    """List stored rules."""\n    agent = get_agent()\n    rules = await agent.memory_store.get_rules(rule_type)\n    return {\n        "count": len(rules),\n        "rules": [\n            {\n                "id": r.id,\n                "name": r.name,\n                "description": r.description,\n                "rule_type": r.rule_type,\n                "content": r.content,\n                "tags": r.tags,\n            }\n            for r in rules\n        ],\n    }\n\n\n@router.post("/rules")\nasync def create_rule(request: RuleCreateRequest):\n    """Create a new rule."""\n    from ..memory import Rule\n    import uuid\n\n    agent = get_agent()\n    rule = Rule(\n        id=str(uuid.uuid4()),\n        name=request.name,\n        description=request.description,\n        rule_type=request.rule_type,\n        content=request.content,\n        examples=request.examples,\n        tags=request.tags,\n    )\n    stored = await agent.memory_store.store_rule(rule)\n    return {"id": stored.id, "message": "Rule created successfully"}\n\n\n@router.delete("/rules/{rule_id}")\nasync def delete_rule(rule_id: str):\n    """Delete a rule."""\n    agent = get_agent()\n    deleted = await agent.memory_store.delete_rule(rule_id)\n    if not deleted:\n        raise HTTPException(status_code=404, detail="Rule not found")\n    return {"status": "ok", "message": "Rule deleted"}\n\n\n@router.get("/logic-blocks")\nasync def list_logic_blocks(block_type: Optional[str] = None):\n    """List stored logic blocks."""\n    agent = get_agent()\n    blocks = await agent.memory_store.get_logic_blocks(block_type)\n    return {\n        "count": len(blocks),\n        "blocks": [\n            {\n                "id": b.id,\n                "name": b.name,\n                "block_type": b.block_type,\n                "description": b.description,\n                "formula_pattern": b.formula_pattern,\n                "tags": b.tags,\n            }\n            for b in blocks\n        ],\n    }\n\n\n@router.post("/logic-blocks")\nasync def create_logic_block(request: LogicBlockCreateRequest):\n    """Create a new logic block."""\n    from ..memory import LogicBlock\n    import uuid\n\n    agent = get_agent()\n    block = LogicBlock(\n        id=str(uuid.uuid4()),\n        name=request.name,\n        block_type=request.block_type,\n        description=request.description,\n        formula_pattern=request.formula_pattern,\n        variables=request.variables,\n        tags=request.tags,\n    )\n    stored = await agent.memory_store.store_logic_block(block)\n    return {"id": stored.id, "message": "Logic block created successfully"}\n\n\n@router.delete("/logic-blocks/{block_id}")\nasync def delete_logic_block(block_id: str):\n    """Delete a logic block."""\n    agent = get_agent()\n    deleted = await agent.memory_store.delete_logic_block(block_id)\n    if not deleted:\n        raise HTTPException(status_code=404, detail="Logic block not found")\n    return {"status": "ok", "message": "Logic block deleted"}\n\n\n@router.get("/health")\nasync def health_check():\n    """Health check endpoint with diagnostics."""\n    from ..config import settings\n\n    # Gather non-secret diagnostics\n    config = {\n        "llm_provider": settings.llm_provider,\n        "model_name": settings.model_name,\n        "anthropic_key_present": bool(settings.anthropic_api_key),\n        "openrouter_key_present": bool(settings.openrouter_api_key),\n        "google_credentials_configured": settings.google_credentials_path.exists(),\n    }\n    \n    # Include openrouter_model when using OpenRouter provider\n    if settings.llm_provider == "openrouter":\n        config["openrouter_model"] = settings.openrouter_model\n    \n    diagnostics = {\n        "status": "ok",\n        "service": "sheetsmith",\n        "config": config,\n    }\n\n    return diagnostics